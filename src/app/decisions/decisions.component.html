<!-- navbar decisions -->
<app-nav-decisions/>


<div class="tab-content container-fluid" id="pills-tabContent">
  <!-- pending decisions  -->
  <div
    class="tab-pane fade show active mt-2"
    id="pills-pendingdecisions"
    role="tabpanel"
    aria-labelledby="pills-pendingdecisions-tab"
  >
    @if (pendingTasks.decisions.length > 0){
    <div>
      <div class="row">
        <div class="col">
          <select
            (change)="getPendingTask()"
            id="selectPendingDecision"
            [(ngModel)]="pending_task_selected"
            class="form-select"
            aria-label="Default select example"
          >
            @for(decision of pendingTasks.decisions; track decision.id){
            <option [value]="decision.id">{{ decision.label }}</option>
            }
          </select>
          @if(pending_task?.result){
          <div class="container-information mt-2">
            <div class="card-body">
              <div class="row">
                <div class="col-2 text">
                  <strong>Name</strong>
                </div>
                <div class="col-10">
                  {{pending_task["task description"].name }}
                </div>
              </div>
              <div class="row">
                <div class="col-2 text">
                  <strong>Description</strong>
                </div>
                @if(pending_task['task description']?.description) {
                <div
                  class="col-10"
                  [innerHTML]="
                    pending_task['task description'].description | autolinkPipe
                  "
                ></div>
                }
              </div>
              @if(pending_task['task description'].proposed_approach){
              <div class="row">
                <div class="col-2 text">
                  <strong>Proposed approach</strong>
                </div>
                <div class="col-10 position-relative">
                  @if(pending_task['task description'].proposed_approach.length > 300) {
                  <div
                    [innerHTML]="
                      pending_task['task description'].proposed_approach
                        | slice : 0 : 301
                    "
                  >
                    @if(collapseProposed) {
                    <span>...</span>
                    }
                  </div>
                  } @if(collapseProposed || pending_task['task description'].proposed_approach .length < 300){
                  <div
                    [innerHTML]="
                      pending_task['task description'].proposed_approach
                    "
                  ></div>
                  }

                  <a
                    (click)="collapseProposedApproach()"
                    class="position-absolute top-0"
                    style="left: -5px"
                  >
                    @if(collapseProposed) {
                    <i class="fa-solid plus-icon fa-minus"></i>
                    }@else {
                    <i class="fa-solid plus-icon fa-plus"></i>
                    }
                  </a>
                </div>
              </div>
              } @if(pending_task['task description'].guidance) {
              <div class="row">
                <div class="col-2 text">
                  <strong>Guidance</strong>
                </div>
                <div class="col-10 position-relative">
                  @if(pending_task['task description'].guidance.length > 300 && !collapseguidance) {
                  <div
                    [innerHTML]="
                      pending_task['task description'].guidance
                        | slice : 0 : 301
                    "
                  >
                    @if(!collapseguidance){
                    <span>...</span>
                    }
                  </div>
                  } @if(collapseguidance ||pending_task['task description'].guidance.length < 300) {
                  <div
                    [innerHTML]="pending_task['task description'].guidance"
                  ></div>
                  }

                  <a
                    (click)="collapseGuidance()"
                    class="position-absolute top-0"
                    style="left: -5px"
                  >
                    @if(collapseguidance){
                    <i class="fa-solid plus-icon fa-minus"></i>
                    } @else {
                    <i class="fa-solid plus-icon fa-plus"></i>
                    }
                  </a>
                </div>
              </div>
              }
            </div>
            @if(pending_task){
            <decisions-form [editMode]="false" [task]="pending_task" />
            }
          </div>
          }
        </div>
      </div>
    </div>
    } @else {
    <div>No pending decisions</div>
    }
  </div>
    <!-- end pending decisions  -->
     <!-- completed decisions -->
  <div
    class="tab-pane fade"
    id="pills-pastdecisions"
    role="tabpanel"
    aria-labelledby="pills-pastdecisions-tab"
  >
    <div class="accordion accordion-flush" id="accordionFlushExample">
      <div class="accordion-item">
        <h2 class="accordion-header" id="flush-headingOne">
          <button
            id="tableCollapseDecisions"
            class="accordion-button collapsed"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#flush-collapseOneDecisions"
            aria-expanded="false"
            aria-controls="flush-collapseOneDecisions"
          >
            Completed Task
          </button>
        </h2>
        <div
          id="flush-collapseOneDecisions"
          class="accordion-collapse collapse show"
          aria-labelledby="flush-headingOneDecisions"
          data-bs-parent="#accordionFlushExample"
        >
          <div class="accordion-body">
            <div class="row">
              <div class="col">
                <table id="dtDecisions" class="display compact">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Label</th>
                      <th>Name</th>
                      <th>summary</th>
                      <th>decision</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (decision of results.decisions; track decision.id) {
                    <tr (click)="selectDecision(decision.id)">
                      <td>{{ decision.date | formatDate }}</td>
                      <td>{{ decision.label }}</td>
                      <td>{{ decision.name }}</td>
                      <td>{{ decision.summary | slice : 0 : 150 }}...</td>
                      <td>{{ decision.decision ? "Yes" : "No" }}</td>
                    </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-item">
        <h2 class="accordion-header" id="flush-headingTwo">
          <button
            (click)="showTablePastDecisions()"
            id="pastCollapseDecisions"
            class="accordion-button collapsed"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#flush-collapseTwoDecisions"
            aria-expanded="true"
            aria-controls="flush-collapseTwoDecisions"
          >
            {{ results?.decisionSelected["task description"]?.label }}
          </button>
        </h2>
        <div
          id="flush-collapseTwoDecisions"
          class="accordion-collapse collapse"
          aria-labelledby="flush-headingTwoDecisions"
          data-bs-parent="#accordionFlushExample"
        >
          <div class="accordion-body">
            @if(results.decisionSelected && !global.editModeDecisions){
            <div class="mt-2">
              <hr />
              <div class="card-body mb-3">
                <div class="row">
                  <div class="col-2 text">
                    <strong>Date</strong>
                  </div>
                  <div class="col-10">
                    {{ results.decisionSelected.result.date }}
                  </div>
                </div>
                <div class="row">
                  <div class="col-2 text">
                    <strong>Name</strong>
                  </div>
                  <div class="col-10">
                    {{ results.decisionSelected["task description"].name }}
                  </div>
                </div>
                <div class="row">
                  <div class="col-2 text">
                    <strong>Description</strong>
                  </div>
                  @if(results.decisionSelected['task description']?.description) {
                  <div
                    class="col-10"
                    [innerHTML]="results.decisionSelected['task description'].description | autolinkPipe"
                  ></div>

                  }
                </div>
                <div class="row">
                  <div class="col-2 text">
                    <strong>Method links</strong>
                  </div>
                  @if(pending_task?.['task description']?.method_link[0] !== 'local_models') {
                  <div class="col-10">
                    <div>
                      @for (link of results.decisionSelected['task description'].method_link; track $index) {
                      <span>
                        <a target="_blank" [href]="link">{{ link }}</a>
                        <br />
                      </span>

                      }
                    </div>
                  </div>
                  }
                </div>
              </div>
              <div class="card-body">
                <div class="row pt-1 pb-1">
                  <div class="col-2 text border-bottom">Decision</div>
                  <div class="col border-bottom">
                    @if(results.decisionSelected.result.decision) {
                    <span>Yes</span>
                    }@else {
                    <span>No</span>
                    }
                  </div>
                </div>
                <div class="row pt-1 pb-1">
                  <div
                    class="col-2 text border-bottom d-flex align-items-center"
                  >
                    Documentation
                  </div>
                  <div class="col border-bottom">
                    @for (link of results.decisionSelected.result.links; track $index) {
                    <div class="d-inline mx-1">
                      <button
                        (click)="downloadFile(link.File)"
                        class="btn btn-outline-success mt-2 mb-2"
                      >
                        {{ link.label }}
                      </button>
                    </div>
                    }
                  </div>
                </div>
                <div class="d-flex p-1 justify-content-around">
                  @for (image of listImages; track $index) {
                    <app-card-image [image]="image" />     
                  }
                </div>
                <div class="row pt-1 pb-1">
                  <div class="col-2 text border-bottom">Summary</div>
                  <div class="col border-bottom formatted-text">
                    {{ results.decisionSelected.result.summary }}
                  </div>
                </div>
                <div class="row pt-1 pb-1">
                  <div class="col-2 text border-bottom">Justification</div>
                  <div class="col border-bottom formatted-text">
                    {{ results.decisionSelected.result.justification }}
                  </div>
                </div>
                @if(results.decisionSelected.substance){
                <div class="row pt-1 pb-1">
                  <div class="col-2 text">Substance</div>
                  <div class="col">
                    <table
                      id="dtSubstancesDecisions"
                      class="table table-borderless"
                    >
                      <thead class="text">
                        <tr>
                          <th style="text-align: center">Name</th>
                          <th style="text-align: center">CASRN</th>
                          <th style="text-align: center">SMILES</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (idx of objectKeys(results.decisionSelected.substance); track idx) {
                        <tr>
                          <td
                            style="vertical-align: middle; text-align: center"
                          >
                            {{ results.decisionSelected.substance[idx].name }}
                          </td>
                          <td
                            style="vertical-align: middle; text-align: center"
                          >
                            {{ results.decisionSelected.substance[idx].CASRN }}
                          </td>
                          <td style="text-align: center">
                            <canvas [id]="'decisionCanvas' + idx"></canvas>
                          </td>
                        </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                </div>
                }

                <div class="row">
                  <button
                    [disabled]="!user.write"
                    (click)="editDecision()"
                    class="btn btn-ets-edit"
                  >
                    Edit
                  </button>
                </div>
              </div>
            </div>
            } @if(global.editModeDecisions && user.write){
            <decisions-form
              [editMode]="true"
              [task]="results.decisionSelected"
            />
            }
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- end completed decisions -->
</div>
